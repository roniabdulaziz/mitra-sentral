<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Akun Saya</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: #f1f3f6;
  padding-bottom: 70px;
}

header {
  background: #1565c0;
  color: #fff;
  padding: 14px;
  text-align: center;
  font-weight: 600;
}

.container {
  padding: 14px;
}

.card {
  background: #fff;
  border-radius: 14px;
  padding: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,.1);
  margin-bottom: 14px;
}

.row {
  margin-bottom: 10px;
}

.label {
  font-size: 12px;
  color: #777;
}

.value {
  font-size: 15px;
  font-weight: 600;
}

.mutasi {
  border-top: 1px solid #eee;
  padding-top: 10px;
  margin-top: 10px;
}

.mutasi-item {
  margin-bottom: 10px;
}

.mutasi-item strong {
  font-size: 15px;
}

.mutasi-item small {
  display: block;
  color: #777;
  font-size: 12px;
}

.pagination {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}

.pagination button {
  padding: 8px 14px;
  border: none;
  border-radius: 8px;
  background: #90caf9;
  color: #fff;
  font-weight: 600;
}

.logout {
  background: #c62828;
  color: #fff;
  padding: 14px;
  text-align: center;
  border-radius: 12px;
  font-weight: 600;
}
</style>
</head>

<body>

<header>AKUN SAYA</header>

<div class="container">

  <!-- INFO AKUN -->
  <div class="card">
    <div class="row">
      <div class="label">Nama</div>
      <div class="value" id="nama">-</div>
    </div>

    <div class="row">
      <div class="label">Nomor HP</div>
      <div class="value" id="hp">-</div>
    </div>

    <div class="row">
      <div class="label">Alamat</div>
      <div class="value" id="alamat">-</div>
    </div>

    <div class="row">
      <div class="label">Total Transaksi Hari Ini</div>
      <div class="value">Rp <span id="totalHariIni">0</span></div>
    </div>
  </div>

  <!-- MUTASI -->
  <div class="card">
    <strong>Mutasi Isi Saldo (7 Hari Terakhir)</strong>

    <div id="mutasiList" class="mutasi"></div>

    <div class="pagination">
      <button id="prev">Sebelumnya</button>
      <button id="next">Berikutnya</button>
    </div>
  </div>

  <!-- LOGOUT -->
  <div class="card">
    <div class="logout" id="logout">Logout</div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="guard.js"></script>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://igtrnhjexdxymgoufnoy.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlndHJuaGpleGR4eW1nb3Vmbm95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNjY3NTMsImV4cCI6MjA4MjY0Mjc1M30.r1c85loIq2uqsbqaUQ-Jc7t3R8Lhi3iEiHArXGgw3gc";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= SESSION ================= */
const memberId = localStorage.getItem("member_id");

/* ================= INFO AKUN ================= */
async function loadProfile() {
  const { data } = await sb
    .from("members")
    .select("nama, hp, alamat")
    .eq("id", memberId)
    .single();

  document.getElementById("nama").textContent = data.nama;
  document.getElementById("hp").textContent = data.hp;
  document.getElementById("alamat").textContent = data.alamat || "-";
}

/* ================= TOTAL TRANSAKSI HARI INI ================= */
async function loadTotalHariIni() {
  const today = new Date().toISOString().split("T")[0];

  const { data } = await sb
    .from("saldo_mutasi")
    .select("nominal")
    .eq("member_id", memberId)
    .gte("created_at", today + "T00:00:00");

  const total = (data || []).reduce((a,b) => a + b.nominal, 0);
  document.getElementById("totalHariIni").textContent =
    total.toLocaleString("id-ID");
}

/* ================= MUTASI ================= */
let page = 0;
const limit = 5;

async function loadMutasi() {
  const from = page * limit;
  const to = from + limit - 1;

  const { data } = await sb
    .from("saldo_mutasi")
    .select("*")
    .eq("member_id", memberId)
    .gte("created_at", new Date(Date.now()-7*86400000).toISOString())
    .order("created_at", { ascending: false })
    .range(from, to);

  const list = document.getElementById("mutasiList");
  list.innerHTML = "";

  if (!data || data.length === 0) {
    list.innerHTML = "<small>Tidak ada mutasi</small>";
    return;
  }

  data.forEach(m => {
    const div = document.createElement("div");
    div.className = "mutasi-item";
    div.innerHTML = `
      <strong>+ Rp${m.nominal.toLocaleString("id-ID")}</strong>
      <small>${m.keterangan} â€¢ ${new Date(m.created_at).toLocaleString("id-ID")}</small>
    `;
    list.appendChild(div);
  });
}

document.getElementById("prev").onclick = () => {
  if (page > 0) { page--; loadMutasi(); }
};
document.getElementById("next").onclick = () => {
  page++; loadMutasi();
};

/* ================= LOGOUT ================= */
document.getElementById("logout").onclick = () => {
  localStorage.clear();
  location.href = "/";
};

/* INIT */
loadProfile();
loadTotalHariIni();
loadMutasi();
</script>

</body>
</html>
